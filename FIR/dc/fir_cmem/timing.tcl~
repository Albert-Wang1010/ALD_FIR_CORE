# CMEM timing constraints for 100 MHz operation
# Optimized for memory block synthesis

# Setting variables 
set clk_period 10.00
set clk_uncertainty 0.20      # INCREASED: more realistic for clock jitter
set clk_transition 0.15       # INCREASED: more realistic rise/fall time
set typical_input_delay 1.0   # REDUCED: memory inputs are usually close to logic
set typical_output_delay 1.0  # REDUCED: registered output, less stringent
set typical_wire_load 0.010   # INCREASED: more realistic wire loading

# Create real clock if clock port is found
if {[sizeof_collection [get_ports clk2]] > 0} {
  set clk_name "clk2"
  set clk_port "clk2"
  # 50% duty cycle
  create_clock -name $clk_name -period $clk_period [get_ports $clk_port] 
}

# Set clock uncertainty (accounts for jitter, skew)
set_clock_uncertainty $clk_uncertainty [get_clocks $clk_name]

# Clock transition time
set_clock_transition $clk_transition [get_clocks $clk_name]

# Configure the clock network
set_fix_hold [all_clocks] 
set_dont_touch_network $clk_port 
set_ideal_network $clk_port 

# Set the paths to be ignored in timing opt
# Add false paths for asynchronous reset if needed
if {[sizeof_collection [get_ports rstn]] > 0} {
  set_ideal_network [get_ports rstn]
  # Optionally: set_false_path -from [get_ports rstn]
}

# Set input and output delays
set_driving_cell -lib_cell INVX1TS [all_inputs]
set_input_delay $typical_input_delay [all_inputs] -clock $clk_name 
remove_input_delay -clock $clk_name [find port $clk_port]
remove_input_delay -clock $clk_name [find port rstn]

# Output is registered, so can be more relaxed
set_output_delay $typical_output_delay [all_outputs] -clock $clk_name 

# Set loading of outputs (realistic for driving FIR logic)
set_load $typical_wire_load [all_outputs] 

# CMEM-specific: relax timing on control signals if needed
# These are typically stable when memory is accessed
set_multicycle_path 2 -setup -from [get_ports cload]
set_multicycle_path 1 -hold -from [get_ports cload]

# Memory read is pipelined with 1-cycle latency - this is expected
# No special multicycle needed since it's already registered

# Optional: if memory array inference is causing issues
# set_dont_touch [get_cells -hier *mem*]
